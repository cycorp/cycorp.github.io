<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- Generated by Apache Maven Doxia Site Renderer 1.6 at 2015-12-18 -->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>Cyc Java API Docs &#x2013; Advanced Querying</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon" />
    <style type="text/css" media="all">
      @import url("../../../../css/maven-base.css");
      @import url("../../../../css/maven-theme.css");
      @import url("../../../../css/site.css");
    </style>
    <link rel="stylesheet" href="../../../../css/print.css" type="text/css" media="print" />
    <meta name="Date-Revision-yyyymmdd" content="20151218" />
    <meta http-equiv="Content-Language" content="en" />
        
        </head>
  <body class="composite">
    <div id="banner">
                        <a href="http://www.cyc.com/" id="bannerLeft">
                                                <img src="../../../../../images/cyclogo.png" alt="Cyc Dev Center" />
                </a>
                          <div id="bannerRight">
                Cyc Developer Center
                </div>
            <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="breadcrumbs">
            
                    
                <div class="xleft">
        <span id="publishDate">Last Published: 2015-12-18</span>
                  &nbsp;| <span id="projectVersion">Version: 1.0.0-rc5</span>
                          |                           <a href="../../../../../" title="Cyc Dev Center">Cyc Dev Center</a>
        &gt;
                          <a href="../../../../index.html" title="APIs">APIs</a>
        &gt;
    Advanced Querying
              </div>
            <div class="xright">                    <a href="http://www.cyc.com/" class="externalLink" title="Cycorp">Cycorp</a>
            |
                        <a href="../../../../../" title="Developer Center">Developer Center</a>
            |
                        <a href="../../../../../api/" title="Java APIs">Java APIs</a>
            |
                        <a href="../../../../../ontology-development/" title="Ontologies">Ontologies</a>
            |
                        <a href="../../../../../admin/" title="Cyc Administration">Cyc Administration</a>
            |
                        <a href="../../../../../downloads/" title="Downloads">Downloads</a>
            |
                        <a href="../../../../../issues/" title="Issues">Issues</a>
            |
                        <a href="https://github.com/cycorp" class="externalLink" title="GitHub">GitHub</a>
              
                    
      </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="leftColumn">
      <div id="navcolumn">
             
                    
                                <h5>Cyc Developer Center</h5>
                  <ul>
                  <li class="none">
                          <a href="../../../../../index.html" title="Introduction">Introduction</a>
            </li>
                  <li class="none">
                          <a href="../../../../../issues/index.html" title="Issues">Issues</a>
            </li>
                  <li class="none">
                          <a href="../../../../../downloads/index.html" title="Downloads">Downloads</a>
            </li>
                  <li class="none">
                          <a href="../../../../../xsd/index.html" title="Cyc XSDs">Cyc XSDs</a>
            </li>
                  <li class="none">
                          <a href="../../../../../xsl/index.html" title="Cyc XSL">Cyc XSL</a>
            </li>
          </ul>
                       <h5>Java APIs</h5>
                  <ul>
                  <li class="none">
                          <a href="../../../../index.html" title="Overview">Overview</a>
            </li>
                                                                                                                                                        <li class="expanded">
                          <a href="../../../../core/index.html" title="Core API Suite">Core API Suite</a>
                    <ul>
                      <li class="none">
                          <a href="../../../../core/kb/index.html" title="KB API">KB API</a>
            </li>
                      <li class="none">
                          <a href="../../../../core/query/index.html" title="Query API">Query API</a>
            </li>
                      <li class="none">
                          <a href="../../../../core/session/index.html" title="Session API">Session API</a>
            </li>
                      <li class="none">
                          <a href="../../../../core/readme.html" title="README">README</a>
            </li>
                      <li class="none">
                          <a href="../../../../core/changelog.html" title="CHANGELOG">CHANGELOG</a>
            </li>
                      <li class="none">
                          <a href="../../../../core/download/index.html" title="Download">Download</a>
            </li>
              </ul>
        </li>
                  <li class="none">
                          <a href="../../../../faq/index.html" title="FAQs & HOWTOs">FAQs & HOWTOs</a>
            </li>
                  <li class="none">
                          <a href="../../../../license/index.html" title="License">License</a>
            </li>
          </ul>
                       <h5>Javadocs</h5>
                  <ul>
                  <li class="none">
                          <a href="../../../../core/apidocs/" title="Core API Spec">Core API Spec</a>
            </li>
                  <li class="none">
                          <a href="../../../../core/client/apidocs/" title="Core Client Impl">Core Client Impl</a>
            </li>
          </ul>
                       <h5>Examples</h5>
                  <ul>
                                                                                                                                                <li class="expanded">
                          <a href="../../../../samples/index.html" title="API Usage">API Usage</a>
                    <ul>
                      <li class="none">
                          <a href="../../../../samples/core/index.html" title="Basic Core API Usage">Basic Core API Usage</a>
            </li>
                      <li class="none">
            <strong>Advanced Querying</strong>
          </li>
                      <li class="none">
                          <a href="../../../../samples/core/query/construction/index.html" title="Query Construction">Query Construction</a>
            </li>
                      <li class="none">
                          <a href="../../../../samples/core/query/search/index.html" title="Query Search">Query Search</a>
            </li>
                      <li class="none">
                          <a href="../../../../samples/core/query/justification/index.html" title="Query Justification">Query Justification</a>
            </li>
              </ul>
        </li>
          </ul>
                       <h5>Ontology Development</h5>
                  <ul>
                  <li class="none">
                          <a href="../../../../../ontology-development/index.html" title="Overview">Overview</a>
            </li>
                  <li class="none">
                          <a href="../../../../../ontology-development/tutorials/index.html" title="Tutorials">Tutorials</a>
            </li>
                                                                                                                    <li class="expanded">
                          <a href="http://www.cyc.com/documentation/ontologists-handbook/" class="externalLink" title="Ontologist's Handbook">Ontologist's Handbook</a>
                    <ul>
                      <li class="none">
                          <a href="http://www.cyc.com/documentation/ontologists-handbook/cyc-basics/" class="externalLink" title="Cyc Basics">Cyc Basics</a>
            </li>
                      <li class="none">
                          <a href="http://www.cyc.com/documentation/ontologists-handbook/writing-efficient-cycl/" class="externalLink" title="Efficient CycL">Efficient CycL</a>
            </li>
                      <li class="none">
                          <a href="http://www.cyc.com/documentation/ontologists-handbook/tools-knowledge-editing-and-ontology-development/" class="externalLink" title="Tools">Tools</a>
            </li>
                      <li class="none">
                          <a href="http://www.cyc.com/documentation/ontologists-handbook/cycl-queries/" class="externalLink" title="CycL Queries">CycL Queries</a>
            </li>
              </ul>
        </li>
                                                                                                                    <li class="expanded">
                          <a href="../../../../../ontology-development/references/index.html" title="References">References</a>
                    <ul>
                      <li class="none">
                          <a href="http://www.cyc.com/resource/cyc-vocabulary/" class="externalLink" title="Cyc Vocabulary">Cyc Vocabulary</a>
            </li>
                      <li class="none">
                          <a href="http://www.cyc.com/documentation/glossary" class="externalLink" title="Glossary">Glossary</a>
            </li>
                      <li class="none">
                          <a href="http://www.cyc.com/documentation/abbreviations/" class="externalLink" title="Common Cyc Abbreviations">Common Cyc Abbreviations</a>
            </li>
                      <li class="none">
                          <a href="http://www.cyc.com/thing/" class="externalLink" title="KB Hierarchy diagram">KB Hierarchy diagram</a>
            </li>
              </ul>
        </li>
          </ul>
                       <h5>Cyc Administration</h5>
                  <ul>
                  <li class="none">
                          <a href="http://www.cyc.com/documentation/enterprise-cyc-administrator-handbook/" class="externalLink" title="Cyc Admin Handbook">Cyc Admin Handbook</a>
            </li>
                  <li class="none">
                          <a href="../../../../../admin/faq/index.html" title="Cyc Admin FAQ">Cyc Admin FAQ</a>
            </li>
          </ul>
                                          
                    
            </div>
    </div>
    <div id="bodyColumn">
      <div id="contentBox">
        <div class="section">
<h2><a name="Advanced_Querying"></a>Advanced Querying</h2>
<p>Below is a complete file showing advanced usage of the Query API, including asynchronous answer processing and exhaustive answer reporting.</p>
<link rel="stylesheet" href="http://yandex.st/highlightjs/8.0/styles/default.min.css">
<script src="http://code.jquery.com/jquery-1.11.0.min.js"></script>
<script src="http://yandex.st/highlightjs/8.0/highlight.min.js"></script>
<script>
$(document).ready(function() {
  $('div.source pre').each(function(i, e) {hljs.highlightBlock(e)});
});
</script>

<div class="source">
<pre>package com.cyc.core.examples.advanced;

/*
 * #%L
 * File: AdvancedQuerying.java
 * Project: Core API Use Cases
 * %%
 * Copyright (C) 1995 - 2014 Cycorp, Inc
 * %%
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 * 
 *      http://www.apache.org/licenses/LICENSE-2.0
 * 
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * #L%
 */
import com.cyc.baseclient.exception.ExportException;
import com.cyc.kb.KbCollection;
import com.cyc.kb.KbObject;
import com.cyc.kb.KbCollectionFactory;
import com.cyc.kb.Variable;
import com.cyc.kb.exception.KbException;
import com.cyc.km.query.export.CsvResultsExporter;
import com.cyc.query.InferenceStatus;
import com.cyc.query.InferenceSuspendReason;
import com.cyc.query.Query;
import com.cyc.query.QueryAnswer;
import com.cyc.query.QueryFactory;
import com.cyc.query.QueryListener;
import com.cyc.query.exception.QueryConstructionException;
import com.cyc.session.CycSessionManager;
import com.cyc.session.spi.SessionManager;
import java.util.Arrays;
import java.util.Collection;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

public class AdvancedQuerying {

  public static void main(String[] args) {
    final String exampleName = AdvancedQuerying.class.getSimpleName();
    try (SessionManager sessionMgr = CycSessionManager.getInstance()) {
      System.out.println(&quot;Running &quot; + exampleName + &quot;...&quot;);

      demonstrateIncrementalResultsQuery();

      Query q = QueryFactory.getQuery(&quot;(and (genls HomoSapiens ?TYPE) (scientificName ?TYPE ?NAME))&quot;, &quot;InferencePSC&quot;);
      if (q.getAnswerCount() &gt; 25) {
        System.out.print(&quot;First 25 &quot;);
      }
      System.out.println(&quot;Combined query answers:\n &quot;);
      displayQueryBindings(q, 25);
      exportQueryBindings(q);
      q.close();
      demonstrateTermSubstitution();
    } catch (Exception ex) {
      System.out.println(&quot;Problem building or running demo query.&quot;);
      ex.printStackTrace(System.err);
      System.exit(1);
    } finally {
      System.out.println(&quot;... &quot; + exampleName + &quot; concluded.&quot;);
      System.exit(0);
    }
  }

  /**
   * Demonstrate how terms can be substituted in a Query before it is run.
   *
   */
  public static void demonstrateTermSubstitution() {
    final Map&lt;KbObject, Object&gt; substitutions = new HashMap&lt;&gt;();
    final KbCollection theSpecies;
    try {
      theSpecies = KbCollectionFactory.findOrCreate(&quot;(TheFn BiologicalSpecies)&quot;);
    } catch (Exception ex) {
      throw new RuntimeException(&quot;Problem finding or creating indexical.&quot;, ex);
    }
    final List&lt;String&gt; sampleSpecies = Arrays.asList(&quot;PlainsZebra&quot;, &quot;Ostrich&quot;, &quot;HumpbackWhale&quot;);
    for (final String species : sampleSpecies) {
      try {
        final KbCollection kbSpecies = KbCollectionFactory.get(species);
        if (!kbSpecies.isInstanceOf(&quot;BiologicalSpecies&quot;)) {
          throw new RuntimeException(kbSpecies + &quot; is not known to be a species.&quot;);
        } else {
          final Query indexicalQuery = QueryFactory.getQuery(&quot;(and (genls (TheFn BiologicalSpecies) ?TYPE) (scientificName ?TYPE ?NAME))&quot;, &quot;InferencePSC&quot;);
          substitutions.put(theSpecies, kbSpecies);
          indexicalQuery.substituteTerms(substitutions);
          System.out.println(&quot;\nResults for &quot; + species + &quot;: &quot;);
          displayQueryBindings(indexicalQuery, 5);
          indexicalQuery.close();
        }
      } catch (Exception ex) {
        System.out.println(&quot;Trouble testing &quot; + species + &quot;: &quot; + ex.getLocalizedMessage());
      }
    }
  }

  /* A simple method to traverse and display the bindings for a query.  */
  public static void displayQueryBindings(final Query query, final Integer maxToDisplay) {
    final Collection&lt;Variable&gt; queryVars;
    try {
      queryVars = query.getQueryVariables();
    } catch (KbException ex) {
      throw new RuntimeException(&quot;Couldn't get query variables.&quot;, ex);
    }
    System.out.format(&quot;%-16s&quot;, &quot;Variables:&quot;);
    for (final Variable var : queryVars) {
      System.out.format(&quot;%-24s&quot;, var);
    }
    System.out.println();
    int i = 0;
    final List&lt;QueryAnswer&gt; answers;
    try {
      answers = query.getAnswers();
    } catch (Exception ex) {
      throw new RuntimeException(&quot;Couldn't get query answers.&quot;, ex);
    }
    for (final QueryAnswer answer : answers) {
      final Map&lt;Variable, Object&gt; bindings = answer.getBindings();
      System.out.format(&quot;%-16s&quot;, &quot;Answer &quot; + i + &quot;:&quot;);
      for (final Variable var : queryVars) {
        final Object value = bindings.get(var);
        System.out.format(&quot;%-24s&quot;, value);
      }
      System.out.println();
      if (++i &gt;= maxToDisplay) {
        break;
      }
    }
  }

  /* Using an Exporter to serialize the answers for a query to CSV format.  */
  public static void exportQueryBindings(final Query query) {
    System.out.println(&quot;Exporting &quot; + query);
    System.out.println(&quot;Query answers exported to CSV format:&quot;);
    try {
      new CsvResultsExporter(System.out).export(query);
    } catch (ExportException ex) {
      System.err.println(&quot;Exception exporting query answers:&quot;);
      ex.printStackTrace(System.err);
    }
  }

  /* Sometimes you don't expect all the answers to a query to be returned quickly, and you want to be able to do something with them
   as they come in.  Who knows, you might even have some other reason for handling the asynchronously.
   This example shows how to attach a listeners to a query for all the major query events.  Typically
   the most interesting ones are changes in the inference status (i.e. whether it's running, suspended, etc.)
   and arrival of new answers.
   */
  private static void demonstrateIncrementalResultsQuery() {
    // A query that should get lots of results, not all at once:
    final Query query;
    try {
      query = QueryFactory.getQuery(&quot;(#$and \n&quot;
              + &quot;(#$integerBetween 1 ?N 10000) \n&quot;
              + &quot;(#$isa ?N #$PrimeNumber))&quot;);
    } catch (QueryConstructionException ex) {
      throw new RuntimeException(&quot;Exception constructing query.&quot;, ex);
    }
    query.setMaxTime(30);
    query.setMaxAnswerCount(500);
    query.retainInference();
    // Add a listener that will handle important inference events:
    query.addListener(new QueryListener() {
      @Override
      public void notifyInferenceCreated(Query query) {
        System.out.println(&quot;Created &quot; + query);
      }

      @Override
      public void notifyInferenceStatusChanged(InferenceStatus oldStatus, InferenceStatus newStatus, InferenceSuspendReason suspendReason, Query query) {
        System.out.println(&quot;Inference status changed from &quot; + oldStatus + &quot; to &quot; + newStatus);
        if (InferenceStatus.SUSPENDED.equals(newStatus)) {
          System.out.println(&quot;Suspend reason: &quot; + suspendReason);
        }
      }

      @Override
      public void notifyInferenceAnswersAvailable(Query query, List&lt;QueryAnswer&gt; newAnswers) {
        int answerCount = query.getAnswerCount();
        System.out.println(&quot;New answers! Query now has &quot; + answerCount + &quot; answers.&quot;);
        try {//Do stuff with an answer:
          final QueryAnswer answer = newAnswers.get(newAnswers.size() - 1);
          System.out.println(&quot;Here is &quot; + answer.getId());
          for (final Variable var : query.getQueryVariables()) {
            System.out.println(var + &quot; -&gt; &quot; + answer.getBinding(var));
          }
        } catch (KbException ex) {

        }
        if (answerCount &gt;= 1000) {
          System.out.println(&quot;Got enough answers. Terminating query.&quot;);
          query.stop(null);
        }
      }

      @Override
      public void notifyInferenceTerminated(Query query, Exception e) {
        System.out.println(&quot;Query terminated.&quot;);
      }
    });
    
    try {
      // Start the inference. This won't return until the inference terminates:
      query.performInference();
    } catch (Exception ex) {
      throw new RuntimeException(&quot;Exception performing inference.&quot;, ex);
    }
    query.close();
  }

}
</pre></div></div>
      </div>

<!--
      <div id="disqus_thread"></div>
      <script type="text/javascript">
          /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
          var disqus_shortname = 'cycdev'; // required: replace example with your forum shortname

          /* * * DON'T EDIT BELOW THIS LINE * * */
          (function() {
              var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
              dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
              (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
          })();
      </script>
      <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
      <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    </div>
-->

    <div class="clear">
      <hr/>
    </div>
    <div id="footer">
      <div class="xright">
              Copyright &#169;                    2015
                        <a href="http://www.cyc.com">Cycorp, Inc</a>.
            All rights reserved.      
                    
                  </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
  </body>
</html>
